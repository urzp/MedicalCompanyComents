<!-- t123_block_1 #rec1613353621 StaffPage-->

<style>
    .htmlPattern .backGround {
        display: none;
    }

    .uc-comets_el .t396__artboard{
        padding-bottom: 30px;
    }


</style>

<script>
    let pagination = {
        initItems:3,
        current:0,
        moreShow:3,
    }
    let staffComents
    let visualPatern = []
    let cssZero = 'uc-comets_el'
    let cssNameHtmlPattern = 'htmlPattern'
    let cssNameMainElements = ['patt_backGround', 'patt_title',]
    let cssNameElementsCard = ['patt_avatar', 'patt_name_user', 'patt_date', 'patt_coment', 'patt_Star_1', 'patt_Star_2', 'patt_Star_3', 'patt_Star_4', 'patt_Star_5', 'patt_button_more', 'patt_button_more_title']
    let cssAdapterTilda_to_Html = {
        patt_backGround: 'backGround',
        patt_title: 'title',
        patt_avatar: 'avatar',
        patt_name_user: 'name_user',
        patt_date: 'date',
        patt_coment:'comment_text',
        patt_button_more:'button_more',
        patt_button_more_title:'button_more_title',
    }
    let elenentsStyles = []
    let cssParams = ['left', 'top', 'width', 'height']
    let cssParams_tn_atom = [
        'border-radius', 
        'background-color', 
        'background-position', 
        'border-color',
        'border-style',
        'border-width',
        'box-shadow',
        'transition',
        'vertical-align',
        'color',
        'font-size',
        'font-family',
        'font-weight',
        'text-align',
    ]
    let cssParamsNotCopy = {
        patt_backGround: ['height'],
        patt_coment: ['height', 'width'],
    }


    $(document).ready( function(){
        intSatffPage()
    })

    async function intSatffPage(){
        initVisualPatern()
        await getComments(staff_id)
        staffComents = await filterComents()
        if(staffComents.length==0) return false
        await fillData(pagination.initItems)
        $('.htmlPattern .title').text('Отзывы')
        $('.htmlPattern .backGround').fadeIn()
        initEvents()
    }

    function initEvents(){
        $('.htmlPattern .button_more').click(function(){
            let max = pagination.current + pagination.moreShow
            fillData(max)
            riseZeroBlok()
        })
    }

    function riseZeroBlok(addHeight=450){
        let newHeight =  $('.uc-comets_el .t396__artboard').height() + addHeight
        $('.uc-comets_el .t396__artboard').css({height: newHeight + 'px'})
        $('.uc-comets_el .t396__filter').css({height: newHeight + 'px'})
    }

    function fillData(max){
        staffComents.forEach((item, index)=>{
            if(index < pagination.current) return false
            if(index >= max) return false
            pagination.current++
            let html = createHtmlItem(item)
            $(`.htmlPattern .list_coments`).append(html)
        })
        if(pagination.current>=staffComents.length) $('.htmlPattern .button_more').fadeOut()
    }

    function createHtmlItem(data){
        let html =`<div class="comment id_${data.id}">
                        <div class="title_comment">
                            <div class="avatar" style="background-image: url(${data.user_avatar});"></div>
                            <div class="main_data_coment">
                                <div class="name_user">${data.user_name}</div>
                                <div class="rating_date">
                                    <div class="rating value_${data.rating}">
                                        <img src="https://static.tildacdn.com/tild3035-3761-4830-b462-353762316230/Star_3.svg" alt="" class="star_1">
                                        <img src="https://static.tildacdn.com/tild3035-3761-4830-b462-353762316230/Star_3.svg" alt="" class="star_2">
                                        <img src="https://static.tildacdn.com/tild3035-3761-4830-b462-353762316230/Star_3.svg" alt="" class="star_3">
                                        <img src="https://static.tildacdn.com/tild3035-3761-4830-b462-353762316230/Star_3.svg" alt="" class="star_4">
                                        <img src="https://static.tildacdn.com/tild3035-3761-4830-b462-353762316230/Star_3.svg" alt="" class="star_5">
                                    </div>
                                    <div class="date">${formatDate(data.date)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="comment_text">${data.text}</div>
                    </div>`
        return html
    }

    async function initVisualPatern(){
        hiddeTildaPattern()
        setInterval(async ()=>{
            await readElenentsStyles()
            aplyElenentsStyles()
        }, 300)
    }

    function readElenentsStyles(){
        elenentsStyles = []
        cssNameMainElements.concat(cssNameElementsCard).forEach(name_item=>{
           let pattern_element = getElement(name_item)
           let elenentsStyle = {cssName:name_item}
           elenentsStyles.push(elenentsStyle)
           cssParams.forEach(css_item=>{
                if(!!cssParamsNotCopy[name_item]&&cssParamsNotCopy[name_item].includes(css_item)) {return false} 
                elenentsStyle[css_item] = pattern_element.css(css_item)
           })
           pattern_element_atom = getElement(name_item + ' .tn-atom')
            cssParams_tn_atom.forEach(css_item=>{
                if(!!cssParamsNotCopy[name_item]&&cssParamsNotCopy[name_item].includes(css_item)) {return false} 
                elenentsStyle[css_item] = pattern_element_atom.css(css_item)
           })
        })
    }

    function aplyElenentsStyles(){
        aplyStylesHtmlPattern()
        elenentsStyles.forEach(syles_item=>{
            let cssNameElement_htmlPattern = cssAdapterTilda_to_Html[syles_item.cssName]
            if(!cssNameElement_htmlPattern) return false
            cssNameElement_htmlPattern = `.htmlPattern .${cssNameElement_htmlPattern}`
            $(cssNameElement_htmlPattern).css(syles_item)
        })
    }

    function aplyStylesHtmlPattern(){
        let patt_backGround = elenentsStyles.find(item=>item.cssName='patt_backGround')
        let left = patt_backGround.left
        let top = patt_backGround.top
        $(`.${cssNameHtmlPattern}`).css({left, top})
    }

    //-----------------

    //  hendel functions

    // function lastEl(cssSelector){
    //     let length = $(cssSelector).length
    //     return $(cssSelector)[length-1]
    // }

    function hiddeTildaPattern(){
        cssNameMainElements.forEach(item=>{ getElement(item).css({display:'none'}) }) 
        cssNameElementsCard.forEach(item=>{ getElement(item).css({display:'none'}) }) 
    }

    function getElement(cssName){
        return $(`.${cssZero} .${cssName}`)
    }

    function getPxValue(input){
        return Number(input.split('px')[0])
    }

    function showBlok(){
        $(`.${cssZero} .t396__artboard`).css({opacity: 1.0})
    }

    function formatDate(text_data){
        let d = new Date(text_data)
        return d.getDate() + ' ' + d.toLocaleString('ru-RU', { month: 'short' }) + ' ' + d.getFullYear()
    }
</script>

